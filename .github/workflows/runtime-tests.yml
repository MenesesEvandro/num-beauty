name: Runtime Compatibility Tests

on:
  pull_request:
    branches: [main, dev]
    paths:
      - 'src/**'
      - 'tests/runtime/**'
      - 'package.json'
      - '.github/workflows/runtime-tests.yml'
  push:
    branches: [main, dev]
    paths:
      - 'src/**'
      - 'tests/runtime/**'
      - 'package.json'
      - '.github/workflows/runtime-tests.yml'

jobs:
  # Test on Node.js (multiple versions)
  node:
    name: Node.js ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Run runtime tests
        run: node tests/runtime/test-runtime.mjs

  # Test on Deno
  deno:
    name: Deno ${{ matrix.deno-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        deno-version: ['1.x', '2.x']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Deno ${{ matrix.deno-version }}
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ matrix.deno-version }}
      
      - name: Setup Node.js (for build)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies and build
        run: npm ci && npm run build
      
      - name: Run runtime tests with Deno
        run: deno run --allow-read tests/runtime/test-runtime.mjs

  # Test on Bun
  bun:
    name: Bun ${{ matrix.bun-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        bun-version: ['latest']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ matrix.bun-version }}
      
      - name: Install dependencies with Bun
        run: bun install
      
      - name: Build project
        run: bun run build
      
      - name: Run runtime tests with Bun
        run: bun tests/runtime/test-runtime.mjs

  # Summary job that requires all tests to pass
  runtime-tests-complete:
    name: All Runtime Tests Passed
    runs-on: ubuntu-latest
    needs: [node, deno, bun]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.node.result }}" != "success" ]]; then
            echo "Node.js tests failed"
            exit 1
          fi
          if [[ "${{ needs.deno.result }}" != "success" ]]; then
            echo "Deno tests failed"
            exit 1
          fi
          if [[ "${{ needs.bun.result }}" != "success" ]]; then
            echo "Bun tests failed"
            exit 1
          fi
          echo "All runtime tests passed! âœ“"
